Certainly! **Reciprocal Rank Fusion** (RRF) is a method used to combine the rankings of retrieved documents from different queries based on their ranks in each list. The mathematical formulation helps in determining a combined score for each document, allowing for an effective fusion of results. Hereâ€™s how it works:

### Mathematical Formulation of Reciprocal Rank Fusion

1. **Rank Definition**: 
   - Let \( D \) be the set of documents retrieved from the search process.
   - Each document \( d_i \in D \) can be ranked based on its position in the ranked lists generated by different queries.
   - Let \( R_{j}(d_i) \) denote the rank of document \( d_i \) in the results from the \( j \)-th query. The rank is typically an integer, where 1 represents the top position.

2. **Reciprocal Rank Calculation**:
   - The reciprocal rank for a document \( d_i \) from query \( j \) is given by:
   \[
   RR_{j}(d_i) = \begin{cases} 
   \frac{1}{R_{j}(d_i)} & \text{if } R_{j}(d_i) \text{ exists} \\
   0 & \text{if } d_i \text{ is not retrieved by query } j 
   \end{cases}
   \]

3. **Fusion of Reciprocal Ranks**:
   - To combine the reciprocal ranks across multiple queries, we sum the reciprocal ranks for each document from all queries. Let \( Q \) be the total number of queries.
   - The combined score \( S(d_i) \) for document \( d_i \) is computed as:
   \[
   S(d_i) = \sum_{j=1}^{Q} RR_{j}(d_i)
   \]

4. **Final Ranking**:
   - The documents are then re-ranked based on their combined scores \( S(d_i) \). Higher scores indicate higher relevance based on the ranks from different queries.

### Example Calculation

Let's consider a simple example with 3 queries and 4 documents:

#### Query Results
- **Query 1**:
  - Document A: Rank 1
  - Document B: Rank 2
  - Document C: Not retrieved
  - Document D: Rank 4

- **Query 2**:
  - Document A: Rank 3
  - Document B: Rank 1
  - Document C: Rank 2
  - Document D: Not retrieved

- **Query 3**:
  - Document A: Rank 2
  - Document B: Not retrieved
  - Document C: Rank 1
  - Document D: Rank 3

#### Step 1: Calculate Reciprocal Ranks
- **For Document A**:
  - \( RR_{1}(A) = \frac{1}{1} = 1 \)
  - \( RR_{2}(A) = \frac{1}{3} \approx 0.333 \)
  - \( RR_{3}(A) = \frac{1}{2} = 0.5 \)
  - **Total**: \( S(A) = 1 + 0.333 + 0.5 = 1.833 \)

- **For Document B**:
  - \( RR_{1}(B) = \frac{1}{2} = 0.5 \)
  - \( RR_{2}(B) = \frac{1}{1} = 1 \)
  - \( RR_{3}(B) = 0 \) (not retrieved)
  - **Total**: \( S(B) = 0.5 + 1 + 0 = 1.5 \)

- **For Document C**:
  - \( RR_{1}(C) = 0 \) (not retrieved)
  - \( RR_{2}(C) = \frac{1}{2} = 0.5 \)
  - \( RR_{3}(C) = \frac{1}{1} = 1 \)
  - **Total**: \( S(C) = 0 + 0.5 + 1 = 1.5 \)

- **For Document D**:
  - \( RR_{1}(D) = \frac{1}{4} = 0.25 \)
  - \( RR_{2}(D) = 0 \) (not retrieved)
  - \( RR_{3}(D) = \frac{1}{3} \approx 0.333 \)
  - **Total**: \( S(D) = 0.25 + 0 + 0.333 \approx 0.583 \)

#### Step 2: Final Ranking
- Now, we can rank the documents based on their scores:
  - Document A: \( S(A) \approx 1.833 \)
  - Document B: \( S(B) = 1.5 \)
  - Document C: \( S(C) = 1.5 \)
  - Document D: \( S(D) \approx 0.583 \)

### Final Output Order
1. **Document A**: Score 1.833
2. **Document B**: Score 1.5
3. **Document C**: Score 1.5
4. **Document D**: Score 0.583

In this case, Document A is ranked the highest based on its overall relevance as determined by the fusion of ranks from all queries.

### Conclusion

Reciprocal Rank Fusion is a powerful method for aggregating results from multiple retrieval queries, leveraging the idea that documents appearing higher in multiple rankings are likely to be more relevant. This mathematical framework provides a structured approach to calculating and combining scores, allowing for effective information retrieval in systems like RAG. If you have further questions or need additional details, feel free to ask!
